<!-- index.html written by Savvas Petridis
            June 2016 --> 

<!DOCTYPE html>
<html lang="en">
<head>

    <meta name="viewport" content="minimum-scale=1.0, width=device-width, maximum-scale=1.0, user-scalable=no"/>
    <meta charset="utf-8">

    <title>model</title>

    <link rel="stylesheet" type="text/css" href="/css/joint.css" />
    <link rel="stylesheet" type="text/css" href="/css/switch.css" />
    <script src="/js/jquery.min.js"></script>
    <script src="/js/lodash.min.js"></script>
    <script src="/js/backbone-min.js"></script>
    <script src="/js/joint.js"></script>
    <script src="/js/angular.min.js"></script>

</head>
<body>

    <h1 align = "center">resource graph</h1>
    <dl></dl>

    <!-- ANGULAR STARTS HERE --> 

    <div ng-app="graphApp" ng-controller="graph_controller" data-ng-init="init()" align="center">

        <form>
        view saved graph:
            <select id="graph_options">
            </select>
            <button type="button"  ng-click="retrieve_graph()">select</button>
        </form>

         node type: 
        <label class="switch">
            <input type="checkbox" ng-click="prim_node = !prim_node">
            <div class="slider round"></div>
        </label> 

        delete select:
        <label class="switch">
            <input type="checkbox" ng-click="del_node = !del_node">
            <div class="slider round"></div>
        </label> 

        <div ng-show = "!prim_node">
            <form>  
            regular:
                <input type="text" ng-model="node_name" placeholder="name..."/>
                <button type="button"  ng-click="add_node()">add</button>
            </form>
        </div>

        <div ng-show = "prim_node"> 
         primary:
            <button type="button" ng-click="prim_edit = !prim_edit">edit</button>
            <button type="button" ng-click="prim_add = !prim_add">add</button>

            <div ng-show = "prim_add"> 
                <form>
                    <input type="text" ng-model="primnode_name" placeholder="name..." required />
                    <input type="text" ng-model="primnode_val" placeholder="value..." required />
                    <button type="button" ng-click="add_node()">add</button>
                </form>
            </div>

            <div ng-show = "prim_edit"> 
                <form>
                    <input type="text" ng-model="primnode_edit_name" placeholder="name..." required />
                    <input type="text" ng-model="primnode_edit_val" placeholder="value..." required />
                    <button type="button" ng-click="edit_primary()">edit</button>
                </form>
            </div>
        </div>

        link weight: <input type="text" ng-model="weight" placeholder="weight..."/>

        <br>

        <button type="button" ng-click="delete_all()">delete all</button>
        <button type="button" ng-click="log_values()">log values</button>
        <button type="button"  ng-click="calc_nodes()">calc</button>

        <form>
            <input type="text" ng-model="graph_save_name" placeholder="graph name..." required />
            <button type="button" ng-click="save()">save</button>
        </form>

        <hr>

        <div id="myholder"> </div>

        <script>
            var app = angular.module('graphApp', []);
            app.controller('graph_controller', ['$scope', '$http', '$window', function($scope, $http, $window){

                $scope.i = 0;
                $scope.add_node = false; 
                $scope.graph_to_show = 0;
                $scope.link_count = 0;
                $scope.source_cell = 0; 
                $scope.count = 0; 
                $scope.graph = new joint.dia.Graph;
                $scope.paper = new joint.dia.Paper({
                        el: $('#myholder'),
                        width: 1200,
                        height: 1200,
                        model: $scope.graph, // attached graph here
                        gridSize: 1
                    });

                $window.onload = function() {
                    console.log("initializing...");
                    $scope.init();
                }

                function node(x, y, color, name, value, is_prim_node) {
                    var cell = new joint.shapes.basic.Rect({
                        position: { x: x, y: y },
                        size: { width: 100, height: 30 },
                        attrs: { rect: { fill: color }, value: value, name: name, incre: 0, calculated: false, prim_node: is_prim_node, text: { text: name + "\n" + value, fill: 'white' }}
                    });

                    $scope.graph.addCell(cell);
                    return cell;
                }

                truncateDecimals = function (number, digits) {
                    var multiplier = Math.pow(10, digits),
                    adjustedNum = number * multiplier,
                    truncatedNum = Math[adjustedNum < 0 ? 'ceil' : 'floor'](adjustedNum);

                    return truncatedNum / multiplier;
                };

                function link(source, target, weight_label) {
                    var cell = new joint.shapes.fsa.Arrow({
                        source: { id: source.id },
                        target: { id: target.id },
                        attrs: { weight: weight_label },
                        labels: [{ position: 0.5, attrs: { text: { text: weight_label || '', 'font-weight': 'bold' } } }], 
                    });

                    $scope.graph.addCell(cell);
                    return cell; 
                }; 

                // runs when a node is clicked: 
                $scope.paper.on('cell:pointerclick', function(cellView, evt, x, y) { 
                    // logs name of node clicked
                    console.log(cellView.model.attr('text/text') + " clicked.");   

                    if(!$scope.del_node){

                        // check if this is first node clicked for a link
                        if($scope.link_count == 0){
                            // if so, this will be the source node for a link. 
                            cellView.highlight();
                            $scope.source_cell = cellView.model; 
                            $scope.link_count++; 
                        }

                        // if not, check if the same node has been clicked twice 
                        else if($scope.link_count == 1){
                            // if second node clicked is different
                            if(cellView.model != $scope.source_cell){
                                // create a new link with it from the source node
                                var new_link = link($scope.source_cell, cellView.model, $scope.weight); 
                                ($scope.source_cell.findView($scope.paper)).unhighlight();
                                console.log("new connection.");
                            }
                            // set selected node count to 0 
                            $scope.link_count = 0; 
                        }
                    }
                    else{
                        cellView.model.remove(); 
                    }   
                }); 

                // when white space is clicked, unhighlight node & deselect it
                $scope.paper.on('blank:pointerclick', function(evt, x, y) {
                    $scope.source_cell.findView($scope.paper).unhighlight();
                    $scope.source_cell = 0; 
                    $scope.link_count = 0; 
                });

                $scope.retrieve_graph = function() {

                    // get selected graph information
                    var graph = document.getElementById('graph_options'); 

                    if(graph.selectedIndex != -1){
                        $http.post("/graph", {
                            name: graph.options[graph.selectedIndex].text,
                            index: graph.selectedIndexs,

                        }).success(function(data, status, headers, config) { 
                            delete data['name'];
                            $scope.graph_to_show = data
                            $scope.graph.fromJSON(data);
                            console.log("Success: graph received.");
                        }).
                        error(function(data, status) {
                            console.log("Failure: couldn't get graph.");
                        });
                    }
                };

                $scope.init = function() {
                    $http.get("/retrieve", {

                    }).
                    success(function(data, status, headers, config) { 
                        console.log("Success: graphs fetched.");

                        $scope.fetch_selections(data);

                    }).
                    error(function(data, status) {
                        console.log("Failure: couldn't fetch graphs.");
                    });
                };

                $scope.append_select_list = function() {
                    var option = document.createElement('option');
                    option.value = option.text = $scope.graph_save_name;
                    (document.getElementById('graph_options')).add(option);

                    $scope.i++;
                };

                $scope.fetch_selections = function(graph_names) {

                    if($scope.i == 0) {
                        for(i = 0; i < graph_names.length; i++){
                            var option = document.createElement('option');
                            option.value = option.text = graph_names[i];
                            (document.getElementById('graph_options')).add(option);
                        }
                        $scope.i++;
                    }
                };

                $scope.save = function() {
                    var current_graph = $scope.graph;
                    var graph_json = current_graph.toJSON();
                    graph_json.name = $scope.graph_save_name;

                    $http.post("/", {
                        graph_json
                    }).
                    success(function(data, status, headers, config) { 
                        console.log("Success: new graph saved.");
                    }).
                    error(function(data, status) {
                        console.log("Failure: couldn't save.");
                    });

                    $scope.append_select_list();

                }; 

                $scope.log_values = function(){
                    var nodes = $scope.graph.getElements(); 
                    for(i = 0; i < nodes.length; i++){
                        console.log(nodes[i].attr('text/text') + ": " + nodes[i].attr('value'));
                    }
                }; 

                $scope.delete_all = function() {
                    $scope.count = 0; 
                    $scope.link_count = 0;
                    $scope.graph.clear();
                }; 

                $scope.reset = function() {
                    var nodes = $scope.graph.getElements(); 
                    var current_node = 0; 
                    var is_prim_node = false;
                    for(i = 0; i < nodes.length; i++){
                        current_node = nodes[i];
                        current_node.attr('calculated', false); 
                        current_node.attr('incre', 0); 

                        is_prim_node = current_node.attr('prim_node'); 
                        if(is_prim_node == false){
                            current_node.attr('value', 0); 
                        }
                    }
                }; 

                $scope.update_nodes = function(){
                    var nodes = $scope.graph.getElements();
                    var current_node = 0; 
                    var value = 0;
                    for(i = 0; i < nodes.length; i++){
                        current_node = nodes[i];
                        value = current_node.attr('value');
                        name = current_node.attr('name');
                        current_node.attr('text/text', name + "\n" + value); 
                    }
                }; 

                $scope.calc_nodes = function() {

                    $scope.reset(); 

                    // get nodes
                    var nodes = $scope.graph.getElements(); 
                    var calculated_nodes = 0; 
                    var current_node = 0;
                    var value = 0;
                    var calculated = 0; 
                    var targets = 0;
                    var outbound_links = 0; 
                    var target = 0; 
                    var target_val = 0; 
                    var new_target_val = 0; 
                    var num_inbounds = 0;
                    var increments = 0;
                    var target_incre = 0;
                    var node_incre = 0; 

                    var opt = { outbound : true };  
                    var opt2 = { inbound : true };

                    while(calculated_nodes < nodes.length) {
                        for(i = 0; i < nodes.length; i++){
                            console.log("calculated_nodes: " + calculated_nodes); 
                            current_node = nodes[i]; 
                            value = current_node.attr('value'); 
                            calculated = current_node.attr('calculated'); 
                            num_inbounds = ($scope.graph.getConnectedLinks(current_node, opt2)).length;
                            node_incre = current_node.attr('incre'); 

                            if(node_incre == num_inbounds && !calculated){
                                outbound_links = $scope.graph.getConnectedLinks(current_node, opt); 
                                console.log(outbound_links);
                                for(j = 0; j < outbound_links.length; j++){
                                    target = outbound_links[j].getTargetElement(); 
                                    target_val = target.attr('value');
                                    target_val += value * outbound_links[j].attr('weight');
                                    target_val = truncateDecimals(target_val, 2);
                                    target.attr('value', target_val);  
                                    target_incre = target.attr('incre');  
                                    target_incre++;
                                    target.attr('incre', target_incre); 
                                }
                                current_node.attr('calculated', true); 
                                calculated_nodes++;  
                            } 
                        }
                    }

                    $scope.update_nodes(); 

                    console.log("done"); 
                }; 

                $scope.edit_primary = function() {
                    if($scope.source_cell != 0){
                        var new_name = $scope.primnode_edit_name;
                        var new_value = $scope.primnode_edit_val;
                        $scope.source_cell.attr('name', new_name); 
                        $scope.source_cell.attr('value', new_value); 
                        $scope.source_cell.attr('text/text', new_name + "\n" + new_value); 
                    }
                };

                $scope.add_node = function() {

                    // randomly assign x and y values for the position of newly created node
                    var x = Math.floor((Math.random() * 300) + 1);
                    var y = Math.floor((Math.random() * 300) + 1);

                    if($scope.prim_node == true) {
                        var new_node = node(x, y, 'orange', $scope.primnode_name, $scope.primnode_val, true);
                    }
                    else {
                        var new_node = node(x, y, 'blue', $scope.node_name, 0, false); 
                    }

                    $scope.count++; 
                }; 
            }]);
        </script>

    </div>

</body>
</html>